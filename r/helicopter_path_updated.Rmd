---
title: "Heli-attack times"
author: "MichaelStorey_MichaelJones"
date: "28 May 2020"
output: html_document
---

```         
To Do:
  * Create waterpoints/reservoir/lakes layer
  * Classify water points (long line, medium heavy etc.)
  * Amend script point creation to exclude demand points in the ocean/NSW
  * Improve leaflet maps (scalable symbols? Or IDW raster or something?)
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#set local library path so R knows where to look. You will also need to run this line below before downloading new packages, just due to some cenitex issues.
#.libPaths("D:/R/R-Packages")

# load necessary packages
library(sf)
library(dplyr)
library(leaflet)
library(leaflet.extras)
library(htmltools)

```

### chunk 2

-   Setup all inputs
-   Setup all variables

```{r}

# define output location
output_path <- "C:/Projects/20230829_HeliWaterPoints/test/outputs"

# define input layer locations
dem <- "C:/Projects/20230829_HeliWaterPoints/waterpoints/data/DEM_SE_Tas_mosaic.tif"
water_poly_full_path <- "C:/Projects/20230829_HeliWaterPoints/waterpoints/data/reservoir_all_new.shp"
new_dams_full_path <- "C:/Projects/20230829_HeliWaterPoints/waterpoints/data/potential_dam_locations_14052020.shp"

# helicopter speeds in kilometers per hour
all_empty_kmh <- 148
full_ascend_kmh <- 74
full_level_kmh <- 148 #same as full descending

# point grid size for analysis in metres
point_grid_size<-5000

# path sample density (metres between samples from reservoirs to points)
line_sample_point_dist <- 100

# choose whether to include new dams (1) or not (0). Don't use 1 under a 1k grid, will take too long.
include_new_dams <- 0

```

### chunk 3

-   Load shapefiles
-   Transform coordinate reference system (CRS),and define the variable.
-   Create a point grid across region (ie encompassing the reservoirs of interest).
-   Plot grid points black and water in blue

```{r echo=TRUE, message=FALSE, warning=FALSE}

# load and project shapefiles
water_poly<-st_read(water_poly_full_path,quiet=TRUE) %>% st_transform(3111,quiet=TRUE) 
  # %>% filter(NAME == "UPPER YARRA RESERVOIR" | NAME == "THOMSON DAM" | NAME == "LAKE EILDON" | NAME == "OSHANNASSY RESERVOIR" | NAME == "MAROONDAH RESERVOIR" | NAME == "LAKE WILLIAM HOVELL" | NAME == "LAKE NILLAHCOOTIE" | NAME == "LAKE TALI KARNG" | NAME == "TARGO RESERVOIR" | NAME == "SILVAN RESERVOIR" | NAME == "CARDINIA RESERVOIR" | NAME == "POWELLTOWN DAM" | NAME == "LAKE GLENMAGGIE" | NAME == "BLUE ROCK LAKE")

new_dams<-st_read(new_dams_full_path,quiet=TRUE)  
st_crs(new_dams)<-3111
point_grid<- water_poly %>% st_make_grid(point_grid_size,what='centers') %>% st_as_sf()
water_points<-st_cast(water_poly,"POINT")

# test to see if new dams included based on variable value entered above
if(include_new_dams == 1){water_points<-st_union(water_points,new_dams) %>% st_cast("POINT")}

```

### chunk 4

-   Draw test plots of water points
-   Draw a line from every point in grid to its closest water source.
-   Plot grid points black, lines brown and water in blue

```{r message=FALSE, warning=FALSE}

# test plots of water point locations
plot(st_geometry(point_grid))
plot(st_geometry(water_points),col='blue',add=TRUE)

#draw lines from every grid point to nearest water point
nn<-nngeo::st_nn(point_grid,water_points,k=1,progress = FALSE)
near_lines<-nngeo::st_connect(point_grid,water_points,k=1,progress = FALSE)
near_lines<-st_as_sf(near_lines) 
near_lines$line_id<-seq.int(nrow(near_lines))

water_points$wp_id<-seq.int(nrow(water_points))
point_grid<-st_join(point_grid,water_points,join=st_nearest_feature)
near_lines$wp_id<-point_grid$wp_id

plot(st_geometry(point_grid))
plot(st_geometry(water_points),col='blue',add=TRUE)
plot(st_geometry(near_lines),col="brown",add=TRUE)

```

### chunk 5

-   For every line from point grid to water, densify line (make vertex every 100 metres) and turn vertices into points (transferring line id to new point feature class)
-   Sample the DEM for every line vertex point, and select the point with the maximum elevation.
-   Sample the DEM for elevation of start point (where fire would be) and end point (water point)
-   Calculate the difference in elevation between start, end, and max elevation
-   Plots now have max dem point in red

```{r message=FALSE, warning=FALSE}

# densify lines (make vertices every <line_sample_point_dist> metres)
near_lines_dense<- near_lines%>% smoothr::densify(max_distance=line_sample_point_dist)
near_lines_vertices<-st_cast(near_lines_dense,"POINT",do_split = TRUE,warn = FALSE)

# sample dem
raster_dem<-raster::raster(dem)
water_points$dem_wp<-raster::extract(raster_dem,st_transform(water_points,4326))
point_grid$dem_start<-raster::extract(raster_dem,st_transform(point_grid,4326))
near_lines$dem_start<-point_grid$dem_start

near_lines_vertices$dem_path<-raster::extract(raster_dem,st_transform(near_lines_vertices,4326,quiet=TRUE))
max_dem_vertice<-near_lines_vertices %>% group_by(line_id) %>% filter(dem_path==max(dem_path)) %>% mutate(n=n()) %>% mutate(positionInCategory = 1:n()) %>% filter(positionInCategory == 1)
near_lines$peak_dem<-max_dem_vertice$dem_path

# join height of water point to lines
d<-data.frame(water_points %>% select(wp_id,dem_wp)) %>% select(-geometry)
near_lines<- near_lines %>% left_join(d,by="wp_id") 

# calculate height differences
near_lines$st_peak_diff<-near_lines$peak_dem- near_lines$dem_start
near_lines$wp_peak_diff<-near_lines$peak_dem- near_lines$dem_wp

# draw test plot including max DEM point in red
plot(st_geometry(point_grid))
plot(st_geometry(water_points),col='blue',add=TRUE)
plot(st_geometry(near_lines),add=TRUE,col='brown')
plot(st_geometry(max_dem_vertice),add=TRUE,col = 'red')

```

### chunk 6

-   Calculate the distances between start to high dem point, and high dem point to end (water)
-   Using distances, height differences and speeds (all_empty_kmh\<-148,full_ascend_kmh\<-74,full_level_kmh\<-148) to calculate time on different segments of line. At the moment this assumes heli ascends and descends vertically (not on an angle)

```{r message=FALSE, warning=FALSE}

# get distance between high point and start and end points
high_point_to_wp<-st_distance(max_dem_vertice,water_points)
near_lines$peak_to_wp<-as.numeric(apply(high_point_to_wp, 1, FUN=min))
near_lines$dist<-as.numeric(st_length(near_lines)) 
near_lines$peak_to_start<-near_lines$dist - near_lines$peak_to_wp

# calculate slope
near_lines$slp_wp_dist<-sqrt((near_lines$wp_peak_diff^2)+(near_lines$peak_to_wp^2))
near_lines$slp_start_dist<-sqrt((near_lines$st_peak_diff^2)+(near_lines$peak_to_start^2))

# calculate times
near_lines <- near_lines %>% mutate(time_full_ascend = (wp_peak_diff/1000)/full_ascend_kmh) %>% 
  mutate(time_full_level = (dist/1000)/full_level_kmh) %>% 
  mutate(time_full_descend = (st_peak_diff/1000)/full_level_kmh) %>% 
  mutate(time_empty_ascend = (st_peak_diff/1000)/all_empty_kmh) %>% 
  mutate(time_empty_level = (dist/1000)/all_empty_kmh) %>% 
  mutate(time_empty_descend = (wp_peak_diff/1000)/all_empty_kmh) %>% 
  mutate(total_time = round((time_full_ascend + time_full_level +time_full_descend +
           time_empty_ascend + time_empty_level + time_empty_descend)*60,1) + 2) #plus 2 minutes for fill time

point_grid$total_time<-near_lines$total_time

# calculate times using pythagoras (ie assuming heli flies on angles over)
near_lines <- near_lines %>% mutate(time_full_ascend_slope = (slp_wp_dist/1000)/full_ascend_kmh) %>% 
  mutate(time_full_descend_slope = (slp_start_dist/1000)/full_level_kmh) %>% 
  mutate(time_empty_ascend_slope = (slp_start_dist/1000)/all_empty_kmh) %>% 
  mutate(time_empty_descend_slope = (slp_wp_dist/1000)/all_empty_kmh) %>% 
  mutate(total_time_slope = round((time_full_ascend_slope +time_full_descend_slope +
           time_empty_ascend_slope + time_empty_descend_slope)*60,1) + 2) #plus 2 minutes for fill time

point_grid$total_time<-near_lines$total_time
point_grid$total_time_slope<-near_lines$total_time_slope

st_write(point_grid, paste0(output_path, "point_grid.shp"), delete_layer = TRUE)
st_write(near_lines, paste0(output_path, "near_lines.shp"), delete_layer = TRUE)
#st_write(max_dem_vertice, paste0("D:/TEMP/", "max_dem.shp"), delete_layer = TRUE)
#MJ writes point_grid and near_lines layer at the end

```

### chunk 7 (may not work, simple displays output)

-   Interactive map of time to closest reservoir (in minutes). Click on a point to see the minutes
-   This map is assuming helicopters ascend and descend vertically, and fly horizontally in between

```{r message=FALSE, warning=FALSE}

#distances
point_grid_wgs<-st_transform(point_grid,4326) %>% filter(total_time > 0) %>% as("Spatial")
qpal<- colorNumeric(palette = "YlOrBr",domain = seq(50))

map<-leaflet(point_grid_wgs) %>%
  addTiles() %>% 
  addCircleMarkers(color = ~qpal(total_time), popup=~htmlEscape(total_time), radius=10, fillOpacity = 1) %>% addPolygons(data=as(st_transform(water_poly,4326),"Spatial"))%>% 
  addLegend("bottomright", pal = qpal, values = ~total_time,title = "time in minutes",opacity = 1)# %>%
  #addCircleMarkers(data=as(st_transform(new_dams,4326),"Spatial"),color = "blue", radius=10, fillOpacity = 1) 
map 

```

### chunk 8 (may not work, simple displays output)

-   This map is assuming helicopters fly on angles over peaks

```{r message=FALSE, warning=FALSE}

#distances
point_grid_wgs<-st_transform(point_grid,4326) %>% filter(total_time_slope > 0) %>% as("Spatial")
qpal<- colorNumeric(palette = "YlOrBr",domain = seq(50))

map<-leaflet(point_grid_wgs) %>%
  addTiles() %>% addCircleMarkers(color = ~qpal(total_time_slope), popup=~htmlEscape(total_time_slope), radius=5, fillOpacity = 0.5) %>% addPolygons(data=as(st_transform(water_poly,4326),"Spatial"))%>% 
  addLegend("bottomright", pal = qpal, values = ~total_time_slope,title = "time in minutes",opacity = 1)# %>%
  #addCircleMarkers(data=as(st_transform(new_dams,4326),"Spatial"),color = "blue", radius=10, fillOpacity = 1) 
map 

```

### chunk 9 (may not work, simple displays output)

-   This map is assuming helicopters fly on angles over peaks

```{r message=FALSE, warning=FALSE}

#distances
point_grid_wgs<-st_transform(point_grid,4326) %>% filter(total_time > 0) %>% as("Spatial")
qpal<- colorNumeric(palette = "YlOrBr",domain = seq(50))

map<-leaflet(point_grid_wgs) %>%addProviderTiles(providers$OpenStreetMap.BlackAndWhite) %>% addCircleMarkers(color = ~qpal(total_time), popup=~htmlEscape(total_time), radius=10, fillOpacity = 1) %>% addPolygons(data=as(st_transform(water_poly,4326),"Spatial"))%>% 
  addLegend("bottomright", pal = qpal, values = ~total_time,title = "time in minutes",opacity = 1)# %>%
  #addCircleMarkers(data=as(st_transform(new_dams,4326),"Spatial"),color = "blue", radius=10, fillOpacity = 1) 
map 

```
